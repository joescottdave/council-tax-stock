<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="author" content="Joseph Scott Davies" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <script src="./js/d3.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/queue-async/1.0.7/queue.min.js"></script>
        <link href='https://fonts.googleapis.com/css?family=Open+Sans:300' rel='stylesheet' type='text/css' />
        <style>
            #app{ width: 100%; height: 100vh; font-family: 'Open Sans', Arial, Helvetica, sans-serif;}
        </style>
    </head>
    <body>
        <div id="app">
            <h1>Stock of Properties in Wales Local Authorities broken down by Council Tax Band</h1>
            <!--<svg width="1000px" height="650px"></svg>-->
        </div>
        <script>
            var wales_data;


            queue()
            .defer(d3.csv, "./data/ctsop2016.csv")
            .await(function(error, ctsop2016){
                wales_data = ctsop2016.filter(function(obj){
                    if (/^W0/.test(obj.ECODE)){
                        return obj;
                    };
                });

            // Has to be a better way to do the below
            wales_data.forEach(function(element){
                element.BAND_A = parseInt(element.BAND_A.replace(/,/g,""))
                element.BAND_B = parseInt(element.BAND_B.replace(/,/g,""))
                element.BAND_C = parseInt(element.BAND_C.replace(/,/g,""))
                element.BAND_D = parseInt(element.BAND_D.replace(/,/g,""))
                element.BAND_E = parseInt(element.BAND_E.replace(/,/g,""))
                element.BAND_F = parseInt(element.BAND_F.replace(/,/g,""))
                element.BAND_G = parseInt(element.BAND_G.replace(/,/g,""))
                element.BAND_H = parseInt(element.BAND_H.replace(/,/g,""))
                element.BAND_I = parseInt(element.BAND_I.replace(/,/g,""))
                if (/^Isle/.test(element.AREA_NAME)) {
                    element.AREA_NAME = "Isle of Anglesey / Ynys Mon"
                }
            }, this);
            draw();
            });


            function draw(){
                var stack = d3.stack()
                    .keys(["BAND_A", "BAND_B","BAND_C","BAND_D","BAND_E","BAND_F","BAND_G","BAND_H","BAND_I"])
                    .order(d3.stackOrderNone)
                    .offset(d3.stackOffsetNone);
                var app = document.getElementById("app");
                var height = (app.clientHeight/100)*80;
                var width = (app.clientWidth/100)*95;
                var series = stack(wales_data);
                console.log(series);
                
                    // width = 800,
                    // height = 500;
                var app = d3.select('#app');
                app.append('svg')
                    .attr('height', (height/80)*100)
                    .attr('width', (width/95)*100);
                
                var svg = d3.select('svg'),
                    margin = {top: 20, right: 30, bottom: 30, left: 60};

            var x = d3.scaleBand()
                .domain(wales_data.map(function(d) { return d.AREA_NAME; }))
                .rangeRound([margin.left, width - margin.right])
                .padding(0.1);

            var y = d3.scaleLinear()
                .domain([d3.min(series, minStack), d3.max(series, maxStack)])
                .rangeRound([height - margin.bottom, margin.top]);

            var z = d3.scaleOrdinal(d3.schemeCategory10);
            var letterColor = d3.scaleOrdinal()
                .domain(["BAND_A", "BAND_B","BAND_C","BAND_D","BAND_E","BAND_F","BAND_G","BAND_H","BAND_I"])
                .range(["#FA5A5A", "#FFCB4F","#00BE70", "#295EA4","#5200D8","#EC4A94","#9F8BE5", "#28A9ff", "#FF872F"]);

            svg.append("g")
            .selectAll("g")
            .data(series)
            .enter().append("g")
                .attr("fill", function(d) { console.log(d.key); return letterColor(d.key); })
            .selectAll("rect")
                .data(function(d) { return d; })
            .enter().append("rect")
                .attr("width", x.bandwidth)
                .attr("x", function(d) { return x(d.data.AREA_NAME); })
                .attr("y", function(d) { return y(d[1]); })
                .attr("height", function(d) { return y(d[0]) - y(d[1]); });

            svg.append("g")
                .attr("transform", "translate(0," + y(0) + ")")
                .call(d3.axisBottom(x))
                .selectAll("text")  
                    .style("text-anchor", "start")
                    .attr("dx", ".8em")
                    .attr("dy", ".15em")
                    .attr("transform", "rotate(35)" );

            svg.append("g")
                .attr("transform", "translate(" + margin.left + ",0)")
                .call(d3.axisLeft(y));

            key = svg.append("g")
                .attr("class", "key");
        
            var keyData = [0,1,2,3,4,5,6,7,8];
            var keyBoxes = key.selectAll('.boxes')
                .data(keyData);
            var keyText = key.selectAll('.keytext')
                .data(keyData);
            var letter = d3.scaleOrdinal()
                .domain([0,1,2,3,4,5,6,7,8])
                .range(['A','B','C','D','E','F','G','H','I']);
    
            keyBoxes.enter()
                .append('rect')
                .attr("class", "boxes")
                .attr("height", "20px")
                .attr("width", "20px")
                .attr("transform", function(d,i){ return "translate(" + (width-(width/10)) + "," + ((i+1) * 24) + ")"; })
                .style("stroke", function(d,i){ return letterColor(i); })
                .style("stroke-width", "0px")
                .style("fill", function(d,i){ return letterColor(i); });
            
            keyText.enter()
                .append('text')
                .attr('class', 'keytext')
                .attr("transform", function(d,i){ return "translate("+ (width-(width/10) + 28) + ", " + (15 + ((i+1) * 24)) + ")"; })
                // .style("fill", function(d,i){ return letterColor(i); })
                .style("fill", "black")
                .text(function(d,i){ return "Band " + letter(d); });

            function minStack(array) {
                return d3.min(array, function(d) { return d[0]; });
            }

            function maxStack(array) {
                return d3.max(array, function(d) { return d[1]; });
            }
        }

function createIntermediate(){
    wales_data_intermediate = ['BAND_A','BAND_B','BAND_C','BAND_D','BAND_E','BAND_F','BAND_G','BAND_H', 'BAND_I'].map(function(key, i){
        return wales_data.map(function(d,j){
            return { x: d['AREA_NAME'], y: d[key] };
        })
    })
}

// window.addEventListener("resize", draw);
        </script>
    </body>
</html>