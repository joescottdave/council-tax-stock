<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta name="author" content="Joseph Scott Davies" />
        <link rel="stylesheet" href="./css/template.css" type="text/css" />
        <style>
            section{
                position: relative;
            }
            section div{
                border: 1px white solid;
            }
            section div:first-of-type{
                height: 10%;
                width: 100%;
                position: absolute;
                top: 0;
            }
            section div:nth-of-type(2), section div:nth-of-type(3){
                height: 90%;
                width: 50%;
                position: absolute;
                top: 10%;
                left: 0;
            }
            section div:nth-of-type(3){
                left: 50%;
            }
            .areas{
                fill: white;
                stroke: white;
                stroke-width: 0.5px;
            }

            svg {
                position: absolute;
                top: 0;
            }

            @media screen and (max-aspect-ratio: 15/16){
                section{
                    height: 696px;
                }
                section div:nth-of-type(2) {
                    top: 55%;
                }
                section div:nth-of-type(3){
                    left: 0;
                }
                section div:nth-of-type(2), section div:nth-of-type(3){
                    height: 45%;
                    width:100%;
                }
            }

        </style>
    </head>
    <body>
        <div id="app">
        <header>
            <h1 class="black">Visualising<br/>Council Tax Stock of Properties 2016</h1>
        </header>
        <section>
            <div><h2>Distribution</h2></div>
            <div class="vis"></div>
            <div class="vis"></div>
        </section>
        <section>
            <div><h2 class="black">Median</h2></div>
            <div></div>
            <div class="vis"></div>
        </section>
        <section>
            <div><h2>Comparison with Wages</h2></div>
            <div></div>
            <div class="vis"></div>
        </section>
        </div><!-- #app -->
    <script src="./js/d3.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/queue-async/1.0.7/queue.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/topojson/1.6.20/topojson.min.js"></script>
    <script>
        var active = d3.select(null);
        var wales_data;
        var count = 0;
        var container = document.querySelector('div:nth-of-type(3)');

        function init(){
            queue()
                .defer(d3.json, "./geoJSON/topo_lad.json")
                .defer(d3.csv, "./data/ctsop2016.csv")
                .await(function(error, boundaries, ctsop2016){
                    wales_data = ctsop2016.filter(function(obj){
                        if (/^W0/.test(obj.ECODE)){
                            return obj;
                        };
                });

                    // Has to be a better way to do the below
                wales_data.forEach(function(element){
                element.BAND_A = parseInt(element.BAND_A.replace(/,/g,""))
                element.BAND_B = parseInt(element.BAND_B.replace(/,/g,""))
                element.BAND_C = parseInt(element.BAND_C.replace(/,/g,""))
                element.BAND_D = parseInt(element.BAND_D.replace(/,/g,""))
                element.BAND_E = parseInt(element.BAND_E.replace(/,/g,""))
                element.BAND_F = parseInt(element.BAND_F.replace(/,/g,""))
                element.BAND_G = parseInt(element.BAND_G.replace(/,/g,""))
                element.BAND_H = parseInt(element.BAND_H.replace(/,/g,""))
                element.BAND_I = parseInt(element.BAND_I.replace(/,/g,""))
                if (/^Isle/.test(element.AREA_NAME)) {
                    element.AREA_NAME = "Isle of Anglesey / Ynys Mon"
                }
            }, this);
                    
                    var height = (container.clientHeight/100)*85;
                    var width = (container.clientWidth/100)*95;
                    var visuals = document.querySelectorAll('.vis');
                    console.log(visuals);
                    visuals.forEach(function(element){
                        element.innerHTML = "";
                        d3.select(element)
                            .append('svg')
                    }, this);

                    draw(boundaries);
                    colorMoneyMap(wales_data);

                })
        }

        function draw(lad_bounds){
            var height = (container.clientHeight/100)*85;
            var width = (container.clientWidth/100)*95;
            var visuals = document.querySelectorAll('div:nth-child(3)')
            visuals.forEach(function(element) {
                d3.select(element).select('svg')
                    .attr('height', height)
                    .attr('width', width)
                    .attr('class', 'map');
            });

            var maps = d3.selectAll('.map');

            var g = maps.append('g');
            var projection = d3.geoAlbers()
                .rotate([0,0])
                .scale(1)
                .translate([0,0]);

            var path = d3.geoPath()
                .projection(projection);
        
            var b = path.bounds(topojson.feature(lad_bounds, lad_bounds.objects['lad']));
            var s = .95/Math.max((b[1][0] - b[0][0])/width, (b[1][1] - b[0][1])/height);
            var t = [(width - s * (b[1][0] + b[0][0]))/2, (height - s*(b[1][1] + b[0][1]))/2];

            var areas = g.selectAll(".area")
                .data(topojson.feature(lad_bounds, lad_bounds.objects['lad']).features);

            projection
                .scale(s)
                .translate(t);

            areas
                .enter()
                .append('path')
                .attr('class', 'area')
                .attr('data-key', function(d) { return d['id']; })
                .attr('d', path)
                .style("fill", "#56B949")
                .style("stroke", "#f7f7f7")
                .style("stroke-width", "0.5px")
                .on("click", clicking);
        };

        function colorMoneyMap(data){
            var medColor;
            var medianColor = d3.scaleLinear()
                .domain([0,1,2,3,4])
                .range(["#FA5A5A", "#FFCB4F","#00BE70", "#295EA4" ]);

            var map = document.getElementsByClassName("map")[1]
            var areas = d3.select(map)
                .selectAll(".area");
            areas.on('click', medianClicking)
            .style("fill", function(d){
                var id = this.dataset.key
                var element = data.filter(function(obj){
                    if(obj.ECODE === id){
                        return obj;
                    }
                })
                var list = [element[0].BAND_A, element[0].BAND_B, element[0].BAND_C, element[0].BAND_D, element[0].BAND_E, element[0].BAND_F, element[0].BAND_G, element[0].BAND_H, element[0].BAND_I];
                var length = list.length;

                for (i=0; i < 8; i++){
                    if(isNaN(list[i])){
                        list[i] = 0
                    }
                };


                var target = 0;
                var median = 0;
                for (i=0; i < length; i++) {
                    median += list[i]
                };
                median = Math.round(median/2);
                for (i=0; i < length; i++) {
                    if (target < median) {
                        target += list[i]
                    } else {
                        medColor = medianColor(i-1)
                        break;
                    }
                }
                return medColor;
            });
        }

        function drawChart(ecode){
            console.log(ecode);
            var element = wales_data.filter(function(obj){
                if(obj.ECODE === ecode){
                    return obj;
                }
            })
            var list = [element[0].BAND_A, element[0].BAND_B, element[0].BAND_C, element[0].BAND_D, element[0].BAND_E, element[0].BAND_F, element[0].BAND_G, element[0].BAND_H, element[0].BAND_I];
            var length = list.length;
            for (i=0; i < length; i++){
                if(isNaN(list[i])){
                    list[i] = 0
                }
            };

            var container = document.getElementById("chart");
            var svg = d3.select("#chart").append('svg');
            var gChart = svg.append('g');
            var height = (container.clientHeight/100)*85;
            var width = (container.clientWidth/100)*95;
            var barWidth = width/9;

            svg.attr("height", height);
            svg.attr("width", width);

            var x = d3.scaleLinear()
        .domain([0,d3.max(list)])
        .range([0, ((height/100)*90)]);
    var letters = d3.scaleOrdinal()
        .domain([0,1,2,3,4,5,6,7,8])
        .range(["A","B","C","D","E","F","G","H", "I"]);

    var bar = gChart.selectAll("rect")
        .data(list);
    
    var text = gChart.selectAll("text")
        .data(list);       
    
    gChart.exit().transition().remove();

    bar.transition()
        .attr("transform", function(d,i){ return "translate(" + (i * barWidth) + "," + (height - x(d)) + ")"; })
        .attr("height", function(d){ return x(d); })
        .attr("width", barWidth-1)
        .style("fill", function(){ return (count > 0) ? "#56B949" : "#EE4035" });
    
    text.transition()
        .attr("y", function(d){ return (height - x(d) - 10); })
        .attr("x", function(d,i){return i * barWidth + barWidth / 2 })
        .attr("dy", ".35em")
        .style("fill", function(){ return (count > 0) ? "#EE4035" : "#56B949" })
        .text(function(d,i){return letters(i);}); 

    bar.enter().append("rect")
        .attr("transform", function(d,i){ return "translate(" + (i * barWidth) + "," + (height - x(d)) + ")"; })
        .attr("height", function(d){ return x(d); })
        .attr("width", barWidth-1)
        .style("fill", function(){ return (count > 0) ? "#EE4035" : "#56B949" });

    text.enter().append("text")
        .attr("y", function(d){ return (height - x(d) - 10); })
        .attr("x", function(d,i){return (i * barWidth + barWidth / 2) - 4 })
        .attr("dy", ".35em")
        .style("fill", function(){ return (count > 0) ? "#EE4035" : "#56B949" })
        .text(function(d,i){return letters(i);}); 
    
    count +=1 
}

        function clicking(e){
            if (active.node() === this){
                null;
            } else {
                active.style("fill", "#56B949");
                active = d3.select(this);
                active.transition().style("fill", "#EE4035");
                drawChart(this.dataset.key);
            }
        }

        function medianClicking(e){
            console.log(this.dataset.key);
        }

        window.addEventListener("resize", init);
        init();
    </script>
    </body>
</html>