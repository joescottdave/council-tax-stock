<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Council Tax Stock of Properties in Wales</title>
        
        <meta charset="UTF-8" />
        <meta name="author" content="c1554527" />

        <link rel="stylesheet" type="text/css" href="./css/map.css" />

        <style>
        .circle {
            fill: steelblue;
            fill-opacity: .8;
            stroke: #fff;
        }

        .chart rect{
            fill: #EE4035;
        }

        .chart text {
            fill: #EE4035;
            font: 10px sans-serif;
            text-anchor: end;
        }

        nav {
            float: left;
            clear: both;
            width: 300px;
        }

        svg{
            margin: 10px;
            float: left;
            z-index: 1000;
        }

        /* from index */
        .chart .bar-red{
            fill: #e10000;
        }

        .chart .bar-blue{
            fill: #4874ce;
        }

        .chart text {
            font: 15px sans-serif;
            text-anchor: end;
        }

        .chart .text-blue {
            fill: #4874ce;
        }

        .chart .text-red {
            fill: #e10000;
        }

    </style>
    </head>
    <body>

        <!-- explanatory stuff -->
        <header>
            <h1>Council Tax Stock of Properties in Wales</h1>
            <h2>by Local Authority</h2>
        </header>

        <!-- visualisation container -->
        <div id="vis">
        <div id="histo">
            <svg class="chart">
            </svg>
        </div><!-- #histo -->
        <div id="map">
        </div><!-- #map -->
        </div><!-- #vis -->

        

        <!-- javascript -->
        <script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.5.16/d3.min.js"></script>
        <script src="./js/d3.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/queue-async/1.0.7/queue.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/topojson/1.6.20/topojson.min.js"></script>

        <!-- visualisation js -->
        <script>
            var width;
            var height;

            var svg;
            var g;

            var projection;
            var path;

            var active = d3.select(null);

            var medianColors = d3.scaleOrdinal()
                .domain([0,8])
                .range(["#EE4035", "#F3A530" ,"#56B949", "#30499B"]);

            var tax_data;

            function draw(lad_bounds) {
                projection
                    .scale(1)
                    .translate([0,0]);

                var b = path.bounds(topojson.feature(lad_bounds, lad_bounds.objects['lad']));
                var s = .95/Math.max((b[1][0] - b[0][0])/width, (b[1][1] - b[0][1])/height);
                var t = [(width - s * (b[1][0] + b[0][0]))/2, (height - s*(b[1][1] + b[0][1]))/2];

                projection
                    .scale(s)
                    .translate(t);

                var areas = g.selectAll(".area")
                    .data(topojson.feature(lad_bounds, lad_bounds.objects['lad']).features);

                areas
                    .enter()
                    .append('path')
                    .attr('class', 'area')
                    .attr('id', function(d) { return d['id']; })
                    .attr('d', path)
                    .style('fill', medianColors(2))
                    .on("click", clicking);
            }

            function clicking(d){
                if (active.node() === this){
                    null;
                }else{
                    var id = this.id
                    console.log(this.id);
                    var walesObject = (tax_data.filter(function(obj){
                        return obj.ECODE == "W92000004";
                    }))
                    var arrayObject = (tax_data.filter(function(obj){
                        return obj.ECODE == id;
                    }))
                    var list1 = buildArray(walesObject[0]);
                    var list2 = buildArray(arrayObject[0]);
                    active.style("fill", medianColors(2));
                    active = d3.select(this);
                    active.style("fill", medianColors(0));
                    drawChart(list2);
                }
            }

            function buildArray(object){
                var list = [parseInt(object.BAND_A.replace(/,/g,""), 10), parseInt(object.BAND_B.replace(/,/g,""), 10), parseInt(object.BAND_C.replace(/,/g,""), 10), parseInt(object.BAND_D.replace(/,/g,""), 10), parseInt(object.BAND_E.replace(/,/g,""), 10), parseInt(object.BAND_F.replace(/,/g,""), 10), parseInt(object.BAND_G.replace(/,/g,""), 10), parseInt(object.BAND_H.replace(/,/g,""), 10),parseInt(object.BAND_I.replace(/,/g,""),10)];
                for (i=0; i < 8; i++){
                    if(isNaN(list[i])){
                        list[i] = 0
                    }
                }
                if (isNaN(list[8])) {
                    list.pop()
                }
                return list
            }

            function init() {
                width = document.getElementById("map").clientWidth;
                height = document.getElementById("map").clientHeight;

                map = d3.select("#map")
                    .append("svg")
                    .attr("width", width)
                    .attr("height", height);
                
                g = map.append("g");

                projection = d3.geo.albers()
                    .rotate([0,0]);

                path = d3.geo.path()
                    .projection(projection);

                queue()
                    .defer(d3.json, "./geoJSON/topo_lad.json")
                    .defer(d3.csv, "./data/ctsop2016.csv")
                    .defer(d3.csv, "./data/ctsop2015.csv")
                    .await(function(error, boundaries, ctsop2016, ctsop2015){
                        tax_data = ctsop2016;
                        console.log(tax_data.filter(function(obj){
                            return obj.ECODE == "W06000023";
                        }));
                        
                        draw(boundaries);
                    })
            }

            function drawChart(list){
                var chartWidth = 300,
                chartHeight = 300,
                barHeight = chartHeight/9;
                console.log(chartWidth)
                var x = d3.scaleLinear()
                    .domain([0,d3.max(list)])
                    .range([0, ((chartHeight/100)*90)]);
                var letters = d3.scaleOrdinal()
                    .domain([0,1,2,3,4,5,6,7,8])
                    .range(["A","B","C","D","E","F","G","H", "I"]);
                var chart = d3.select(".chart")
                    .style("height", chartHeight)
                    .style("width", chartWidth);

                var bar = chart.selectAll("rect")
                    .data(list);
                
                var text = chart.selectAll("text")
                    .data(list);

                // var selector = d3.select("select");
                // console.log(selector.property('selectedIndex'))

                // var heading = d3.select("nav").append("h2")
                //     .html(chartData[selector.property('selectedIndex')].AREA_NAME)
                //     .style("color", "red");             

                bar.exit().transition().remove();
                text.exit().transition().remove();

                bar.transition()
                    .attr("transform", function(d,i){ return "translate(" + (i * barHeight) + "," + (chartHeight - x(d)) + ")"; })
                    .attr("height", function(d){ return x(d); })
                    .attr("width", barHeight-1);
                
                text.transition()
                    .attr("y", function(d){ return (chartHeight - x(d) - 10); })
                    .attr("x", function(d,i){return i * barHeight + barHeight / 2 })
                    .attr("dy", ".35em")
                    .text(function(d,i){return letters(i);}); 

                bar.enter().append("rect")
                    .attr("transform", function(d,i){ return "translate(" + (i * barHeight) + "," + (chartHeight - x(d)) + ")"; })
                    .attr("height", function(d){ return x(d); })
                    .attr("width", barHeight-1);

                text.enter().append("text")
                    .attr("y", function(d){ return (chartHeight - x(d) - 10); })
                    .attr("x", function(d,i){return i * barHeight + barHeight / 2 })
                    .attr("dy", ".35em")
                    .text(function(d,i){return letters(i);}); 
            }

            function drawChartProportional(list1, list2){
                var chartWidth = 300,
                chartHeight = 300,
                barHeight = chartHeight/18;
                barWidth = chartHeight/18;
                console.log(chartWidth)
                

                var letters = d3.scaleOrdinal()
                    .domain([0,1,2,3,4,5,6,7,8])
                    .range(["A","B","C","D","E","F","G","H", "I"]);
                var chart = d3.select(".chart")
                    .style("height", chartHeight)
                    .style("width", chartWidth);

                var proportionalScale = d3.scaleLinear()
                    .range([0, ((height/100)*90)]);
                
                var text = chart.selectAll(".label");
                var textBlue = chart.selectAll(".text-blue")
                    .data(list2);
                var textRed = chart.selectAll(".text-red")
                    .data(list1);
                
                var barBlue = chart.selectAll(".bar-blue")
                    .data(list2);
                var barRed = chart.selectAll(".bar-red")
                    .data(list1);  

                text.remove();
                textRed.exit().transition().remove();
                textBlue.exit().transition().remove();
                barBlue.exit().transition().remove();
                barRed.exit().transition().remove();

                proportionalScale.domain([0,d3.max(list1)]);

                barRed.transition()
                    .attr("transform", function(d,i){ return "translate(" + (i * (barHeight/2)) + "," + (chartHeight - proportionalScale(d) - (chartHeight/10)) + ")"; })
                    .attr("height", function(d){ return proportionalScale(d); })
                
                textRed.transition()
                    .attr("transform", function(d,i){ return "translate(" + (i * (barHeight/2) + (barHeight/4)) + "," + (chartHeight - (chartHeight/13)) + ")"; })
                    .text(function(d,i){ return letters(i) });

                barRed.enter().append("rect")
                    .attr("class","bar-red")
                    .attr("transform", function(d,i){ return "translate(" + (i * (barHeight/2)) + "," + (chartHeight - proportionalScale(d) - (chartHeight/10)) + ")"; })
                    .attr("height", function(d){ return proportionalScale(d); })
                    .attr("width", barWidth-2);
                
                textRed.enter().append("text")
                    .attr("class", "text-red")
                    .attr("transform", function(d,i){ return "translate(" + (i * (barHeight/2) + (barHeight/4)) + "," + (chartHeight - (chartHeight/13)) + ")"; })
                    .text(function(d,i){ return letters(i) });

                proportionalScale.domain([0,d3.max(list2)]);

                barBlue.transition()
                    .attr("transform", function(d,i){ return "translate(" + ((i * barHeight/2) + (9*barHeight/2)) + "," + (chartHeight - proportionalScale(d) - (chartHeight/10)) + ")"; })
                    .attr("height", function(d){ return proportionalScale(d); });

                textBlue.transition()
                    .attr("transform", function(d,i){ return "translate(" + (i * (barHeight/2) + (barHeight/4) + (9*barHeight/2)) + "," + (chartHeight - (chartHeight/13)) + ")"; })
                    .text(function(d,i){ return letters(i) });

                barBlue.enter().append("rect")
                    .attr("class","bar-blue")
                    .attr("transform", function(d,i){ return "translate(" + ((i * barHeight/2) + (9*barHeight/2)) + "," + (chartHeight - proportionalScale(d) - (chartHeight/10)) + ")"; })
                    .attr("height", function(d){ return proportionalScale(d); })
                    .attr("width", barWidth-2);

                textBlue.enter().append("text")
                    .attr("class", "text-blue")
                    .attr("transform", function(d,i){ return "translate(" + (i * (barHeight/2) + (barHeight/4) + (9 * barHeight/2)) + "," + (chartHeight - (chartHeight/13)) + ")"; })
                    .text(function(d,i){ return letters(i) });
            }

            init();            

                   
                    // // Function for filling areas for chloropleth
                    // .attr('fill', function(d){
                    //     for(var i = 0; i < tax_data.length; i++){
                    //         if(tax_data[i].ECODE === d.id){
                    //             var key = Math.round(
                    //                 (parseInt(tax_data[i].BAND_B.replace(',','')) / parseInt(tax_data[i].ALL_PROPERTIES.replace(',','')))*100
                    //                 )
                    //             console.log(tax_data[i].AREA_NAME, key)
                    //             return colorThing(key)
                    //         }
                    //     }
                    //     console.log('boo');
                    //     return '#eeeeee';
                    // })
                    // var colorThing = d3.scale.linear()
                    //     .domain([0,100])
                    //     .range(["#FF0000", "#0000FF"]);

                    // var colors = {
                    //     "A": "#FF0000",
                    //     "B": "#CC4400",
                    //     "C": "#998800",
                    //     "D": "#44CC00",
                    //     "E": "#00FF00",
                    //     "F": "#00CC44",
                    //     "G": "#009988",
                    //     "H": "#0044CC",
                    //     "I": "#0000FF",
                    // };
        </script>
    </body>
</html>